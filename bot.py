import discord
from discord.ext import commands
import os
import json
from aiohttp import web
import asyncio
import openai
from functools import partial

# Tokenek Render environment-b≈ël
DISCORD_TOKEN = os.getenv("DISCORD_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# OpenAI be√°ll√≠t√°s
openai.api_key = OPENAI_API_KEY

# Intents
intents = discord.Intents.default()
intents.message_content = True
intents.reactions = True
intents.guilds = True
intents.members = True

# Bot p√©ld√°ny
bot = commands.Bot(command_prefix='!', intents=intents)

# F√°jlok
ALLOWED_GUILDS_FILE = "Reaction.ID.txt"
REACTION_ROLES_FILE = "reaction_roles.json"
ACTIVATE_INFO_FILE = "activateinfo.txt"

# Enged√©lyezett szerverek bet√∂lt√©se
def load_allowed_guilds():
    if not os.path.exists(ALLOWED_GUILDS_FILE):
        return set()
    with open(ALLOWED_GUILDS_FILE, "r", encoding="utf-8") as f:
        ids = set()
        for line in f:
            s = line.strip()
            if s.isdigit():
                ids.add(int(s))
        return ids

allowed_guilds = load_allowed_guilds()

# Reaction roles bet√∂lt√©se (robosztusabb)
if os.path.exists(REACTION_ROLES_FILE):
    with open(REACTION_ROLES_FILE, "r", encoding="utf-8") as f:
        try:
            raw = json.load(f)
            reaction_roles = {}
            for gid_s, msgs in raw.items():
                try:
                    gid = int(gid_s)
                except:
                    continue
                reaction_roles[gid] = {}
                if isinstance(msgs, dict):
                    for mid_s, emoji_map in msgs.items():
                        try:
                            mid = int(mid_s)
                        except:
                            continue
                        reaction_roles[gid][mid] = emoji_map
        except json.JSONDecodeError:
            reaction_roles = {}
else:
    reaction_roles = {}

# Ment√©s
def save_reaction_roles():
    with open(REACTION_ROLES_FILE, "w", encoding="utf-8") as f:
        json.dump({
            str(gid): {str(mid): em for mid, em in msgs.items()}
            for gid, msgs in reaction_roles.items()
        }, f, ensure_ascii=False, indent=4)

# Glob√°lis parancsellen≈ërz√©s (kiv√©ve !dbactivate)
@bot.check
async def guild_permission_check(ctx):
    # Ha nincs parancs objektum (ritka), engedj√ºk
    if ctx.command is None:
        return True
    # dbactivate mindenhol fusson
    if ctx.command.name == "dbactivate":
        return True
    # minden m√°s parancs csak enged√©lyezett szervereken fusson
    return ctx.guild is not None and ctx.guild.id in allowed_guilds

@bot.event
async def on_ready():
    print(f"‚úÖ Bejelentkezett: {bot.user.name}")

@bot.command()
@commands.has_permissions(administrator=True)
async def addreaction(ctx, message_id: int, emoji: str, *, role_name: str):
    guild_id = ctx.guild.id
    channel = ctx.channel

    if guild_id not in reaction_roles:
        reaction_roles[guild_id] = {}
    if message_id not in reaction_roles[guild_id]:
        reaction_roles[guild_id][message_id] = {}
    reaction_roles[guild_id][message_id][emoji] = role_name
    save_reaction_roles()

    try:
        message = await channel.fetch_message(message_id)
        await message.add_reaction(emoji)
    except Exception as e:
        await ctx.send(f"Hozz√°adva, de nem siker√ºlt reag√°lni: {e}")
    else:
        await ctx.send(f"üîß `{emoji}` ‚Üí `{role_name}` (√ºzenet ID: `{message_id}`)")

@bot.command()
@commands.has_permissions(administrator=True)
async def removereaction(ctx, message_id: int, emoji: str):
    guild_id = ctx.guild.id
    if (
        guild_id in reaction_roles and
        message_id in reaction_roles[guild_id] and
        emoji in reaction_roles[guild_id][message_id]
    ):
        del reaction_roles[guild_id][message_id][emoji]
        if not reaction_roles[guild_id][message_id]:
            del reaction_roles[guild_id][message_id]
        if not reaction_roles[guild_id]:
            del reaction_roles[guild_id]
        save_reaction_roles()
        await ctx.send(f"‚ùå `{emoji}` elt√°vol√≠tva (√ºzenet: `{message_id}`)")
    else:
        await ctx.send("‚ö†Ô∏è Nem tal√°lhat√≥ az emoji vagy √ºzenet.")

@bot.command()
@commands.has_permissions(administrator=True)
async def listreactions(ctx):
    guild_id = ctx.guild.id
    if guild_id not in reaction_roles or not reaction_roles[guild_id]:
        await ctx.send("‚ÑπÔ∏è Nincs be√°ll√≠tott reakci√≥ ebben a szerverben.")
        return

    msg = ""
    for msg_id, emoji_map in reaction_roles[guild_id].items():
        msg += f"üì© √úzenet ID: `{msg_id}`\n"
        for emoji, role in emoji_map.items():
            msg += f"   {emoji} ‚Üí `{role}`\n"
    await ctx.send(msg)

# !dbhelp parancs ‚Äì √∂sszes parancs list√°z√°sa blokksz√∂vegben
@bot.command()
async def dbhelp(ctx):
    help_text = """```
üìå El√©rhet≈ë parancsok:
!addreaction <√ºzenet_id> <emoji> <szerepk√∂r>   - Reakci√≥ hozz√°ad√°sa (admin)
!removereaction <√ºzenet_id> <emoji>           - Reakci√≥ elt√°vol√≠t√°sa (admin)
!listreactions                                - Reakci√≥k list√°z√°sa (admin)
!dbactivate                                   - Aktiv√°ci√≥s inf√≥ megtekint√©se
!g <k√©rd√©s>                                   - ChatGPT-4 v√°lasz (mindenkinek enged√©lyezett szerveren)
!dbhelp                                       - Ez a s√∫g√≥
```"""
    await ctx.send(help_text)

# !dbactivate ‚Äì tartalom megjelen√≠t√©se az activateinfo.txt-b≈ël
@bot.command()
async def dbactivate(ctx):
    if not os.path.exists(ACTIVATE_INFO_FILE):
        await ctx.send("‚ö†Ô∏è Az activateinfo.txt f√°jl nem tal√°lhat√≥.")
        return

    with open(ACTIVATE_INFO_FILE, "r", encoding="utf-8") as f:
        content = f.read()

    if not content.strip():
        await ctx.send("‚ö†Ô∏è Az activateinfo.txt f√°jl √ºres.")
        return

    await ctx.send(content)

# √öj !g parancs ‚Äì ChatGPT-4 v√°lasz (mindenkinek az enged√©lyezett szervereken)
@bot.command()
async def g(ctx, *, prompt: str):
    # Kiz√°r√≥lag enged√©lyezett szervereken m≈±k√∂dj√∂n
    if not ctx.guild or ctx.guild.id not in allowed_guilds:
        await ctx.send("‚ö†Ô∏è Ez a parancs csak enged√©lyezett szervereken haszn√°lhat√≥.")
        return

    if not OPENAI_API_KEY:
        await ctx.send("‚ùå Az OPENAI_API_KEY nincs be√°ll√≠tva a k√∂rnyezetben.")
        return

    await ctx.trigger_typing()

    def call_openai():
        return openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=1000,
            temperature=0.7
        )

    try:
        # Ne blokkoljuk az esem√©nyhurokot: futtatjuk executorban
        loop = asyncio.get_event_loop()
        response = await loop.run_in_executor(None, call_openai)

        # Robustabb kinyer√©s, k√ºl√∂nb√∂z≈ë openai-pakk verzi√≥khoz
        reply = ""
        if response and getattr(response, "choices", None):
            choice = response.choices[0]
            if isinstance(choice, dict):
                reply = choice.get("message", {}).get("content") or choice.get("text") or ""
            else:
                try:
                    reply = choice.message["content"]
                except Exception:
                    reply = getattr(choice, "text", "") or ""
        else:
            reply = ""

        if not reply:
            await ctx.send("‚ö†Ô∏è Nem √©rkezett √©rdemi v√°lasz a ChatGPT-t≈ël.")
            return

        # √úzenetfeloszt√°s 2000 char felett
        for chunk in [reply[i:i+2000] for i in range(0, len(reply), 2000)]:
            await ctx.send(chunk)

    except Exception as e:
        await ctx.send(f"‚ùå Hiba t√∂rt√©nt a ChatGPT h√≠v√°sa k√∂zben: {e}")

# Reakci√≥kezel√©s
@bot.event
async def on_raw_reaction_add(payload):
    if payload.user_id == bot.user.id:
        return
    if payload.guild_id not in allowed_guilds:
        return

    guild = bot.get_guild(payload.guild_id)
    if not guild:
        return

    emoji = str(payload.emoji)
    roles = reaction_roles.get(payload.guild_id, {}).get(payload.message_id)
    role_name = roles.get(emoji) if roles else None

    if role_name:
        role = discord.utils.get(guild.roles, name=role_name)
        member = guild.get_member(payload.user_id)
        if role and member:
            await member.add_roles(role)
            print(f"‚úÖ {member} kapta: {role.name}")

@bot.event
async def on_raw_reaction_remove(payload):
    if payload.guild_id not in allowed_guilds:
        return

    guild = bot.get_guild(payload.guild_id)
    if not guild:
        return

    emoji = str(payload.emoji)
    roles = reaction_roles.get(payload.guild_id, {}).get(payload.message_id)
    role_name = roles.get(emoji) if roles else None

    if role_name:
        role = discord.utils.get(guild.roles, name=role_name)
        member = guild.get_member(payload.user_id)
        if role and member:
            await member.remove_roles(role)
            print(f"‚ùå {member} elvesztette: {role.name}")

# Webszerver: gy√∂k√©r
async def handle(request):
    return web.Response(text="‚úÖ DarkyBot √©l!", content_type='text/html')

# JSON megtekint≈ë ‚Äì nyersen, sz√©pen form√°zva
async def get_json(request):
    if not os.path.exists(REACTION_ROLES_FILE):
        return web.json_response({}, status=200, dumps=lambda x: json.dumps(x, ensure_ascii=False, indent=4))

    with open(REACTION_ROLES_FILE, "r", encoding="utf-8") as f:
        try:
            data = json.load(f)
        except json.JSONDecodeError:
            data = {}
    return web.json_response(data, status=200, dumps=lambda x: json.dumps(x, ensure_ascii=False, indent=4))

# Webserver setup
app = web.Application()
app.router.add_get("/", handle)
app.router.add_get("/reaction_roles.json", get_json)

async def start_webserver():
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, "0.0.0.0", 8080)
    await site.start()

# Ind√≠t√°s
async def main():
    print("‚úÖ Bot ind√≠t√°s folyamatban...")
    print("DISCORD_TOKEN:", "‚úÖ be√°ll√≠tva" if DISCORD_TOKEN else "‚ùå HI√ÅNYZIK")
    print("OPENAI_API_KEY:", "‚úÖ be√°ll√≠tva" if OPENAI_API_KEY else "‚ùå HI√ÅNYZIK")

    await start_webserver()

    try:
        await bot.start(DISCORD_TOKEN)
    except Exception as e:
        print(f"‚ùå Hiba a bot ind√≠t√°sakor: {e}")

if __name__ == "__main__":
    asyncio.run(main())
